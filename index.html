<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fenêtre — perception</title>
<style>
  body{
    margin:0;background:#000;
    display:flex;justify-content:center;align-items:center;
    height:100vh;overflow:hidden;
    -webkit-tap-highlight-color: transparent;
  }
  img,video{max-width:100vw;max-height:100vh;display:block;}

  /* 1) 黑屏短呼吸开场 */
  #black{
    position:fixed;inset:0;background:#000;
    opacity:1;transition:opacity 1.2s ease;
    pointer-events:none;z-index:10;
  }

  /* start 静帧：淡入 + 极轻呼吸 */
  #start{
    display:none;cursor:pointer;
    opacity:0;transition:opacity 1.2s ease;
    z-index:1;
  }
  #start.breath{
    animation:startBreath 6.5s ease-in-out infinite;
  }
  @keyframes startBreath{
    0%   { filter: brightness(1.00) contrast(1.00) saturate(1.00); }
    50%  { filter: brightness(1.03) contrast(1.02) saturate(1.02); }
    100% { filter: brightness(1.00) contrast(1.00) saturate(1.00); }
  }

  /* 视频段 */
  #v1,#v2,#v3{display:none;z-index:2;}

  /* end 暗化层：慢慢变暗 + 极轻呼吸 */
  #endveil{
    position:fixed;inset:0;background:#000;
    opacity:0;pointer-events:none;
    transition:opacity 12s ease;
    z-index:20;
    --veilBase: 0.35; /* 结尾暗化强度：0.25更轻，0.45更压迫 */
  }
  #endveil.breathe{
    animation:endBreath 7.5s ease-in-out infinite;
  }
  @keyframes endBreath{
    0%   { opacity: var(--veilBase); }
    50%  { opacity: calc(var(--veilBase) + 0.05); }
    100% { opacity: var(--veilBase); }
  }

  /* 法语提示 */
  #hint{
    position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
    color:rgba(255,255,255,.55);
    font:14px/1 system-ui;
    letter-spacing:.08em;
    user-select:none;
    display:none;
    z-index:30;
    text-shadow:0 1px 8px rgba(0,0,0,.35);
  }
</style>
</head>
<body>

<div id="black"></div>
<div id="endveil"></div>

<img id="start" src="start.jpg" alt="start">
<video id="v1" src="part1.mp4" playsinline preload="auto"></video>
<video id="v2" src="part2.mp4" playsinline preload="auto"></video>
<video id="v3" src="part3.mp4" playsinline preload="auto"></video>

<div id="hint">« entrer »</div>

<audio id="inside" src="inside.mp3" loop></audio>
<audio id="outside" src="outside.mp3" loop></audio>
<audio id="noise"  src="noise.mp3"  loop></audio>

<script>
const black   = document.getElementById("black");
const endveil = document.getElementById("endveil");
const start   = document.getElementById("start");
const hint    = document.getElementById("hint");

const v1 = document.getElementById("v1");
const v2 = document.getElementById("v2");
const v3 = document.getElementById("v3");

const inside = document.getElementById("inside");
const outside= document.getElementById("outside");
const noise  = document.getElementById("noise");

let state = "intro";     // intro | ready | entered | playing | ended
let audioUnlocked = false;

function clamp(v){ return Math.max(0, Math.min(1, v)); }
function fade(a,from,to,ms){
  let i=0, steps=60;
  a.volume = clamp(from);
  const t = setInterval(()=>{
    i++;
    a.volume = clamp(from + (to-from)*(i/steps));
    if(i>=steps) clearInterval(t);
  }, ms/steps);
}

function hideAllVisual(){
  start.style.display="none";
  v1.style.display="none";
  v2.style.display="none";
  v3.style.display="none";
}

function resetVideos(){
  [v1,v2,v3].forEach(v=>{
    try{ v.pause(); }catch(e){}
    v.currentTime = 0;
  });
}

function stopAllAudio(){
  [inside,outside,noise].forEach(a=>{
    try{ a.pause(); }catch(e){}
    a.currentTime = 0;
  });
}

/**
 * ✅ 关键：手机音频解锁
 * iOS/微信/很多移动浏览器需要在“用户交互事件”里触发 play() 才允许后续播放。
 * 这里做一次“触发-暂停”，让之后的淡入淡出都能正常工作。
 */
async function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;

  // 先把音量设为0，避免突然响
  inside.volume = 0.0;
  outside.volume= 0.0;
  noise.volume  = 0.0;

  try{ await inside.play(); }catch(e){}
  try{ await outside.play(); }catch(e){}
  try{ await noise.play(); }catch(e){}

  // 立刻暂停外部两条，只保留inside待用
  try{ outside.pause(); }catch(e){}
  try{ noise.pause(); }catch(e){}

  // inside 保持在可播放状态（不暂停），后面我们会把它淡入
}

function showStart(){
  hideAllVisual();

  // 取消结尾暗化层
  endveil.classList.remove("breathe");
  endveil.style.opacity = "0";

  start.style.display = "block";
  start.style.opacity = "0";
  start.classList.add("breath");

  hint.style.display  = "block";
  hint.textContent    = "« entrer »";

  setTimeout(()=> start.style.opacity = "1", 30);
  state = "ready";
}

function startIntro(){
  hideAllVisual();
  resetVideos();
  stopAllAudio();

  // 重置呼吸
  start.classList.remove("breath");

  // 黑屏短开场（1.2s）
  black.style.transition = "none";
  black.style.opacity = "1";
  void black.offsetWidth;
  black.style.transition = "opacity 1.2s ease";
  state = "intro";

  setTimeout(()=>{ black.style.opacity = "0"; }, 150);
  setTimeout(()=>{ showStart(); }, 1200);
}

async function enterWithInside(){
  // 第一次点击：解锁音频 + inside开始（但画面仍停在start）
  await unlockAudioOnce();

  // inside 从0淡入到0.45（更“像呼吸进入空间”）
  inside.volume = 0.0;
  fade(inside, 0.0, 0.45, 1200);

  hint.textContent = "« ouvrir »";
  state = "entered";
}

async function beginPlay(){
  hint.style.display = "none";
  start.style.display = "none";
  start.classList.remove("breath");

  v1.style.display = "block";
  v1.currentTime = 0;
  v1.play();
  state = "playing";
}

/* v1 -> v2 */
v1.onended = ()=>{
  v1.style.display="none";
  v2.style.display="block";
  v2.currentTime=0;
  v2.play();

  // part2：inside在2.5s开始淡出，1.5s完成
  setTimeout(()=> fade(inside, inside.volume, 0.00, 1500), 2500);

  // outside：0 -> 0.55（前3s淡入）
  outside.currentTime = 0;
  outside.volume = 0.0;
  outside.play().catch(()=>{});
  fade(outside, 0.0, 0.55, 3000);
};

/* v2 -> v3 */
v2.onended = ()=>{
  v2.style.display="none";
  v3.style.display="block";
  v3.currentTime=0;
  v3.play();

  // outside 抬强：0.55 -> 0.78（2s）
  fade(outside, outside.volume, 0.78, 2000);

  // noise 淡入：0 -> 0.25（2s）
  noise.currentTime = 0;
  noise.volume = 0.0;
  noise.play().catch(()=>{});
  fade(noise, 0.0, 0.25, 2000);

  // outside 轻微不稳定（更紧张的呼吸）
  let phase=0;
  const wobble = setInterval(()=>{
    if(state!=="playing" || v3.style.display==="none"){ clearInterval(wobble); return; }
    phase += 0.11;
    const base=0.78, amp=0.06;
    outside.volume = clamp(base + Math.sin(phase)*amp + Math.sin(phase*0.43)*(amp*0.6));
  }, 120);
};

/* 结尾 */
v3.onended = ()=>{
  try{ v3.pause(); }catch(e){}
  state = "ended";

  // 结尾慢暗化 + 呼吸（像感知退潮）
  endveil.style.opacity = getComputedStyle(endveil).getPropertyValue("--veilBase") || "0.35";
  setTimeout(()=> endveil.classList.add("breathe"), 12000);

  hint.textContent = "« recommencer »";
  hint.style.display = "block";
};

/* 点击控制：ready->entered->playing；playing/ended->重来 */
document.body.addEventListener("click", ()=>{
  if(state==="ready"){
    enterWithInside();
  }else if(state==="entered"){
    beginPlay();
  }else if(state==="playing" || state==="ended"){
    startIntro();
  }
});

startIntro();
</script>
</body>
</html>