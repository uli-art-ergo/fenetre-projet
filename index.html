<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perception</title>
<style>
  body{margin:0;background:#000;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;}
  img,video{max-width:100vw;max-height:100vh;display:block;}

  /* 黑屏开场 */
  #black{
    position:fixed;inset:0;background:#000;opacity:1;
    transition:opacity 1.2s ease;
    pointer-events:none;
    z-index:10;
  }

  /* start 静帧：淡入 + 轻呼吸 */
  #start{
    display:none;cursor:pointer;
    opacity:0;transition:opacity 1.2s ease;
    z-index:1;
  }
  #start.breath{
    animation: startBreath 6.5s ease-in-out infinite;
  }
  @keyframes startBreath{
    0%   { filter: brightness(1.00) contrast(1.00) saturate(1.00); }
    50%  { filter: brightness(1.03) contrast(1.02) saturate(1.02); }
    100% { filter: brightness(1.00) contrast(1.00) saturate(1.00); }
  }

  /* 视频 */
  #v1,#v2,#v3{display:none;z-index:2;}

  /* 结尾暗化层：慢慢变暗 + 极轻呼吸 */
  #endveil{
    position:fixed;inset:0;background:#000;
    opacity:0;pointer-events:none;
    transition:opacity 12s ease;
    z-index:20;
  }
  #endveil.breathe{
    animation: endBreath 7.5s ease-in-out infinite;
  }
  @keyframes endBreath{
    0%   { opacity: var(--veilBase, 0.35); }
    50%  { opacity: calc(var(--veilBase, 0.35) + 0.05); }
    100% { opacity: var(--veilBase, 0.35); }
  }

  /* 提示文字（法语） */
  #hint{
    position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
    color:rgba(255,255,255,.55);
    font: 14px/1 system-ui;
    letter-spacing:.08em;
    user-select:none;
    display:none;
    z-index:30;
    text-shadow:0 1px 8px rgba(0,0,0,.35);
  }
</style>
</head>
<body>

<div id="black"></div>
<div id="endveil"></div>

<img id="start" src="start.jpg" alt="start">
<video id="v1" src="part1.mp4" playsinline preload="auto"></video>
<video id="v2" src="part2.mp4" playsinline preload="auto"></video>
<video id="v3" src="part3.mp4" playsinline preload="auto"></video>

<div id="hint">« entrer »</div>

<audio id="inside" src="inside.mp3" loop preload="auto"></audio>
<audio id="outside" src="outside.mp3" loop preload="auto"></audio>
<audio id="noise"  src="noise.mp3"  loop preload="auto"></audio>

<script>
const black=document.getElementById("black");
const endveil=document.getElementById("endveil");
const start=document.getElementById("start");
const hint=document.getElementById("hint");

const v1=document.getElementById("v1");
const v2=document.getElementById("v2");
const v3=document.getElementById("v3");

const inside=document.getElementById("inside");
const outside=document.getElementById("outside");
const noise=document.getElementById("noise");

let state = "intro"; // intro | ready | entered | playing | ended
let unlocked = false;

function clamp(v){ return Math.max(0, Math.min(1, v)); }
function fade(a,from,to,ms){
  let i=0,steps=60;
  a.volume=clamp(from);
  const t=setInterval(()=>{
    i++;
    a.volume=clamp(from+(to-from)*(i/steps));
    if(i>=steps) clearInterval(t);
  }, ms/steps);
}

function hideAllVisual(){
  start.style.display="none";
  v1.style.display="none";
  v2.style.display="none";
  v3.style.display="none";
}

function resetVideos(){
  [v1,v2,v3].forEach(v=>{ try{v.pause();}catch(e){} v.currentTime=0; });
}

function stopAllAudio(){
  [inside,outside,noise].forEach(a=>{
    try{ a.pause(); }catch(e){}
    a.currentTime=0;
  });
}

/* ✅ 手机端音频解锁：在“用户点击”里触发一次 play
   outside/noise 触发时保持静音并立刻暂停，避免乱响 */
async function unlockAudioOnce(){
  if(unlocked) return;
  unlocked = true;

  // inside：允许正常播放（但我们仍在 enterWithInside 里开始）
  // outside/noise：解锁但不发声
  try{
    outside.currentTime = 0;
    outside.volume = 0.0;
    await outside.play();
    outside.pause();
    outside.currentTime = 0;
  }catch(e){}

  try{
    noise.currentTime = 0;
    noise.volume = 0.0;
    await noise.play();
    noise.pause();
    noise.currentTime = 0;
  }catch(e){}
}

function showStart(){
  hideAllVisual();

  endveil.classList.remove("breathe");
  endveil.style.opacity = "0";
  endveil.style.setProperty("--veilBase", "0.35");

  start.style.display="block";
  start.style.opacity="0";
  start.classList.add("breath");

  hint.style.display="block";
  hint.textContent = "« entrer »";

  setTimeout(()=> start.style.opacity="1", 30);
  state="ready";
}

function startIntro(){
  hideAllVisual();
  resetVideos();
  stopAllAudio();

  start.classList.remove("breath");

  black.style.transition="none";
  black.style.opacity="1";
  void black.offsetWidth;
  black.style.transition="opacity 1.2s ease";
  state="intro";

  setTimeout(()=>{ black.style.opacity="0"; }, 150);
  setTimeout(()=>{ showStart(); }, 1200);
}

async function enterWithInside(){
  // 第一次点击：解锁音频 + inside 开始（手机必须）
  await unlockAudioOnce();

  inside.currentTime = 0;
  inside.volume = 0.45;

  try{ await inside.play(); }catch(e){}

  hint.textContent = "« ouvrir »";
  state="entered";
}

function beginPlay(){
  hint.style.display="none";
  start.style.display="none";
  start.classList.remove("breath");

  v1.style.display="block";
  v1.currentTime=0;
  v1.play();

  state="playing";
}

// v1 -> v2
v1.onended = ()=>{
  v1.style.display="none";
  v2.style.display="block";
  v2.currentTime=0;
  v2.play();

  // part2：2.5秒开始 inside 淡出（1.5秒完成）
  setTimeout(()=> fade(inside, inside.volume, 0.00, 1500), 2500);

  // outside：前3秒淡入到0.55
  outside.currentTime = 0;
  outside.volume = 0.00;
  outside.play().catch(()=>{ setTimeout(()=> outside.play().catch(()=>{}), 200); });
  fade(outside, 0.00, 0.55, 3000);
};

// v2 -> v3
v2.onended = ()=>{
  v2.style.display="none";
  v3.style.display="block";
  v3.currentTime=0;
  v3.play();

  // outside 抬强 + noise 淡入
  fade(outside, outside.volume, 0.78, 2000);

  noise.currentTime = 0;
  noise.volume=0.00;
  noise.play().catch(()=>{ setTimeout(()=> noise.play().catch(()=>{}), 200); });
  fade(noise, 0.00, 0.25, 2000);

  // outside 轻微不稳定呼吸（更紧张）
  let phase=0;
  const wobble=setInterval(()=>{
    if(state!=="playing" || v3.style.display==="none"){ clearInterval(wobble); return; }
    phase+=0.11;
    const base=0.78, amp=0.06;
    outside.volume = clamp(base + Math.sin(phase)*amp + Math.sin(phase*0.43)*(amp*0.6));
  }, 120);
};

// 结尾：停住 + 慢慢暗化 + 轻呼吸
v3.onended = ()=>{
  try{ v3.pause(); }catch(e){}
  state="ended";

  endveil.style.setProperty("--veilBase", "0.35");
  endveil.style.opacity = "0.35";
  setTimeout(()=> endveil.classList.add("breathe"), 12000);

  hint.textContent = "« recommencer »";
  hint.style.display="block";
};

// 点击控制（保持你原本的交互）
document.body.addEventListener("click", ()=>{
  if(state==="ready"){
    enterWithInside();
  }else if(state==="entered"){
    beginPlay();
  }else if(state==="playing" || state==="ended"){
    startIntro();
  }
});

startIntro();
</script>

</body>
</html>